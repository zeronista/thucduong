<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout}">
<head>
    <title>Sản phẩm</title>
</head>
<body>
    <th:block layout:fragment="styles">
        <link rel="stylesheet" th:href="@{/css/product.css}">
    </th:block>

    <main layout:fragment="content">
        <!-- Hero Section -->
        <section class="hero-section">
            <div class="container">
                <h1 class="hero-title">Sản phẩm</h1>
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item"><a th:href="@{/}">Trang chủ</a></li>
                        <li class="breadcrumb-item active">Sản phẩm</li>
                    </ol>
                </nav>
            </div>
        </section>

        <!-- Products Section -->
        <section class="products-section">
            <div class="container">
                <div class="products-layout">
                    <!-- Sidebar Filters -->
                    <aside class="sidebar">
                        <!-- Search -->
                        <div class="filter-section">
                            <h3 class="filter-title">Tìm kiếm</h3>
                            <form th:action="@{/products}" method="get" class="search-form">
                                <input type="search" name="q" th:value="${searchQuery}" 
                                       placeholder="Tìm sản phẩm..." class="search-input">
                                <button type="submit" class="search-btn">
                                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <circle cx="11" cy="11" r="8"></circle>
                                        <path d="m21 21-4.35-4.35"></path>
                                    </svg>
                                </button>
                            </form>
                        </div>

                        <!-- Categories -->
                        <div class="filter-section">
                            <h3 class="filter-title">Danh mục sản phẩm</h3>
                            <ul class="category-list">
                                <li>
                                    <a th:href="@{/products}" 
                                       th:classappend="${currentCategory == null ? 'active' : ''}">
                                        Tất cả sản phẩm
                                    </a>
                                </li>
                                <li>
                                    <a th:href="@{/products(category='gao-lut')}" 
                                       th:classappend="${currentCategory == 'gao-lut' ? 'active' : ''}">
                                        Gạo lứt
                                    </a>
                                </li>
                                <li>
                                    <a th:href="@{/products(category='bun-pho')}" 
                                       th:classappend="${currentCategory == 'bun-pho' ? 'active' : ''}">
                                        Bún, phở
                                    </a>
                                </li>
                                <li>
                                    <a th:href="@{/products(category='bot-ngu-coc')}" 
                                       th:classappend="${currentCategory == 'bot-ngu-coc' ? 'active' : ''}">
                                        Bột ngũ cốc
                                    </a>
                                </li>
                                <li>
                                    <a th:href="@{/products(category='hat-dinh-duong')}" 
                                       th:classappend="${currentCategory == 'hat-dinh-duong' ? 'active' : ''}">
                                        Hạt dinh dưỡng
                                    </a>
                                </li>
                                <li>
                                    <a th:href="@{/products(category='tra-thao-moc')}" 
                                       th:classappend="${currentCategory == 'tra-thao-moc' ? 'active' : ''}">
                                        Trà thảo mộc
                                    </a>
                                </li>
                                <li>
                                    <a th:href="@{/products(category='gia-vi')}" 
                                       th:classappend="${currentCategory == 'gia-vi' ? 'active' : ''}">
                                        Gia vị
                                    </a>
                                </li>
                                <li>
                                    <a th:href="@{/products(category='dau-an')}" 
                                       th:classappend="${currentCategory == 'dau-an' ? 'active' : ''}">
                                        Dầu ăn
                                    </a>
                                </li>
                            </ul>
                        </div>

                        <!-- Price Filter -->
                        <div class="filter-section">
                            <h3 class="filter-title">Khoảng giá</h3>
                            <form th:action="@{/products}" method="get" class="price-filter">
                                <input type="hidden" name="category" th:value="${currentCategory}">
                                <input type="hidden" name="q" th:value="${searchQuery}">
                                <div class="price-inputs">
                                    <input type="number" name="minPrice" placeholder="Từ" 
                                           class="price-input" min="0">
                                    <span class="price-separator">-</span>
                                    <input type="number" name="maxPrice" placeholder="Đến" 
                                           class="price-input" min="0">
                                </div>
                                <button type="submit" class="btn btn-secondary btn-sm">Áp dụng</button>
                            </form>
                        </div>

                        <!-- Tags -->
                        <div class="filter-section">
                            <h3 class="filter-title">Thẻ phổ biến</h3>
                            <div class="tag-cloud">
                                <a href="#" class="tag">Organic</a>
                                <a href="#" class="tag">Không gluten</a>
                                <a href="#" class="tag">Thuần chay</a>
                                <a href="#" class="tag">Ít đường</a>
                                <a href="#" class="tag">Giàu protein</a>
                                <a href="#" class="tag">Omega-3</a>
                            </div>
                        </div>

                        <!-- Recently Viewed -->
                        <div class="filter-section">
                            <h3 class="filter-title">Sản phẩm vừa xem</h3>
                            <div class="recent-products">
                                <div class="recent-product">
                                    <img th:src="@{/images/product-placeholder.jpg}" alt="Product">
                                    <div class="recent-info">
                                        <h4>Gạo lứt huyết rồng</h4>
                                        <p class="recent-price">89.000 đ</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </aside>

                    <!-- Main Content -->
                    <div class="main-content">
                        <!-- Toolbar -->
                        <div class="toolbar">
                            <div class="results-info">
                                <p>Hiển thị <span th:text="${products.size()}">0</span> trong <span th:text="${totalItems}">0</span> sản phẩm</p>
                            </div>
                            <div class="toolbar-actions">
                                <div class="sort-dropdown">
                                    <label for="sort">Sắp xếp:</label>
                                    <select id="sort" name="sort" onchange="updateSort(this.value)">
                                        <option value="createdAt" th:selected="${sortBy == 'createdAt'}">Mới nhất</option>
                                        <option value="name" th:selected="${sortBy == 'name'}">Tên A-Z</option>
                                        <option value="price_asc" th:selected="${sortBy == 'price_asc'}">Giá tăng dần</option>
                                        <option value="price_desc" th:selected="${sortBy == 'price_desc'}">Giá giảm dần</option>
                                        <option value="rating" th:selected="${sortBy == 'rating'}">Đánh giá cao</option>
                                    </select>
                                </div>
                                <div class="view-modes">
                                    <button class="view-mode active" data-view="grid" title="Xem dạng lưới">
                                        <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                                            <rect x="3" y="3" width="7" height="7"></rect>
                                            <rect x="14" y="3" width="7" height="7"></rect>
                                            <rect x="3" y="14" width="7" height="7"></rect>
                                            <rect x="14" y="14" width="7" height="7"></rect>
                                        </svg>
                                    </button>
                                    <button class="view-mode" data-view="list" title="Xem dạng danh sách">
                                        <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                                            <rect x="3" y="4" width="18" height="2"></rect>
                                            <rect x="3" y="11" width="18" height="2"></rect>
                                            <rect x="3" y="18" width="18" height="2"></rect>
                                        </svg>
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Products Grid -->
                        <div class="products-grid" id="productsGrid">
                            <div class="product-card" th:each="product : ${products}">
                                <a th:href="@{/products/{slug}(slug=${product.slug})}">
                                    <div class="product-image">
                                        <img th:src="${product.media?.images[0]?.url ?: '/images/product-placeholder.jpg'}" 
                                             th:alt="${product.name}" 
                                             class="lazy">
                                        <span class="product-badge sale" th:if="${product.pricing.sale != null}">
                                            -<span th:text="${#numbers.formatDecimal((product.pricing.regular - product.pricing.sale) / product.pricing.regular * 100, 0, 0)}">%</span>
                                        </span>
                                        <span class="product-badge new" th:if="${product.flags?.isNew}">Mới</span>
                                        <div class="product-overlay">
                                            <button class="quick-view" th:attr="data-product-id=${product.id}">
                                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                    <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                                                    <circle cx="12" cy="12" r="3"></circle>
                                                </svg>
                                                Xem nhanh
                                            </button>
                                        </div>
                                    </div>
                                    <div class="product-info">
                                        <div class="product-category" th:text="${product.category?.main}">Danh mục</div>
                                        <h3 class="product-name" th:text="${product.name}">Tên sản phẩm</h3>
                                        <div class="product-rating" th:if="${product.ratings?.average != null}">
                                            <div class="stars">
                                                <span class="star" th:each="i : ${#numbers.sequence(1, 5)}" 
                                                      th:classappend="${i <= product.ratings.average ? 'filled' : ''}">★</span>
                                            </div>
                                            <span class="rating-count">(<span th:text="${product.ratings.count}">0</span>)</span>
                                        </div>
                                        <div class="product-price">
                                            <span class="price-current" 
                                                  th:text="${#numbers.formatDecimal(product.pricing.sale ?: product.pricing.regular, 0, 0, 'COMMA')} + ' đ'">0 đ</span>
                                            <span class="price-original" th:if="${product.pricing.sale != null}" 
                                                  th:text="${#numbers.formatDecimal(product.pricing.regular, 0, 0, 'COMMA')} + ' đ'">0 đ</span>
                                        </div>
                                        <div class="product-actions">
                                            <button class="add-to-cart" 
                                                    th:attr="data-product-id=${product.id},
                                                            data-product-name=${product.name},
                                                            data-product-price=${product.pricing.sale ?: product.pricing.regular}">
                                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                    <circle cx="9" cy="21" r="1"></circle>
                                                    <circle cx="20" cy="21" r="1"></circle>
                                                    <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"></path>
                                                </svg>
                                                Thêm vào giỏ
                                            </button>
                                            <button class="add-to-wishlist" th:attr="data-product-id=${product.id}" title="Thêm vào yêu thích">
                                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                    <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path>
                                                </svg>
                                            </button>
                                        </div>
                                    </div>
                                </a>
                            </div>
                        </div>

                        <!-- Empty State -->
                        <div class="empty-state" th:if="${products.isEmpty()}">
                            <svg width="80" height="80" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                                <circle cx="12" cy="7" r="4"></circle>
                            </svg>
                            <h3>Không tìm thấy sản phẩm</h3>
                            <p>Vui lòng thử lại với từ khóa khác hoặc xóa bộ lọc</p>
                            <a th:href="@{/products}" class="btn btn-primary">Xem tất cả sản phẩm</a>
                        </div>

                        <!-- Pagination -->
                        <nav class="pagination" th:if="${totalPages > 1}">
                            <ul class="pagination-list">
                                <li th:classappend="${currentPage == 0 ? 'disabled' : ''}">
                                    <a th:href="@{/products(page=${currentPage - 1}, category=${currentCategory}, q=${searchQuery}, sort=${sortBy})}" 
                                       class="pagination-link" th:if="${currentPage > 0}">
                                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <polyline points="15 18 9 12 15 6"></polyline>
                                        </svg>
                                    </a>
                                    <span class="pagination-link disabled" th:if="${currentPage == 0}">
                                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <polyline points="15 18 9 12 15 6"></polyline>
                                        </svg>
                                    </span>
                                </li>
                                
                                <li th:each="i : ${#numbers.sequence(0, totalPages - 1)}" 
                                    th:if="${i == 0 || i == totalPages - 1 || (i >= currentPage - 2 && i <= currentPage + 2)}"
                                    th:classappend="${i == currentPage ? 'active' : ''}">
                                    <a th:href="@{/products(page=${i}, category=${currentCategory}, q=${searchQuery}, sort=${sortBy})}" 
                                       class="pagination-link" th:text="${i + 1}">1</a>
                                </li>
                                
                                <li th:classappend="${currentPage == totalPages - 1 ? 'disabled' : ''}">
                                    <a th:href="@{/products(page=${currentPage + 1}, category=${currentCategory}, q=${searchQuery}, sort=${sortBy})}" 
                                       class="pagination-link" th:if="${currentPage < totalPages - 1}">
                                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <polyline points="9 18 15 12 9 6"></polyline>
                                        </svg>
                                    </a>
                                    <span class="pagination-link disabled" th:if="${currentPage == totalPages - 1}">
                                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <polyline points="9 18 15 12 9 6"></polyline>
                                        </svg>
                                    </span>
                                </li>
                            </ul>
                        </nav>
                    </div>
                </div>
            </div>
        </section>

        <!-- Quick View Modal -->
        <div class="modal" id="quickViewModal">
            <div class="modal-content">
                <button class="modal-close">&times;</button>
                <div class="modal-body">
                    <!-- Quick view content will be loaded here -->
                </div>
            </div>
        </div>
    </main>

    <th:block layout:fragment="scripts">
        <script th:src="@{/js/product.js}"></script>
    </th:block>
</body>
</html>